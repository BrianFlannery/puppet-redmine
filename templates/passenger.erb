# File Managed by Puppet
NameVirtualHost <%= @server_name %>
<% if @ssl %>
<VirtualHost <%= @server_name %>:80>
    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteRule /(.*) https://%{HTTP_HOST}:443/$1 [R=302,NE]

    ServerSignature Off
</VirtualHost>
<% end -%>
<% if @ssl %>
<VirtualHost <%= @server_name %>:443>
<% else %>
<VirtualHost <%= @server_name %>:80>
<% end -%>
        LoadModule passenger_module <%= @install_dir %>/.rbenv/versions/<%= @ruby_version %>/lib/ruby/gems/1.9.1/gems/passenger-<%= @passenger_version %>/buildout/apache2/mod_passenger.so
        PassengerRoot <%= @install_dir %>/.rbenv/versions/<%= @ruby_version %>/lib/ruby/gems/1.9.1/gems/passenger-<%= @passenger_version %>
        PassengerDefaultRuby <%= @install_dir %>/.rbenv/versions/<%= @ruby_version %>/bin/ruby

        # you probably want to tune these settings
        PassengerHighPerformance on
        PassengerMaxPoolSize 12
        PassengerPoolIdleTime 1500
        # PassengerMaxRequests 1000
        PassengerStatThrottleRate 120

        RailsBaseURI /

        <% if @ssl %>
        SSLEngine on
        SSLProtocol <%= @ssl_protocol %>
        SSLCipherSuite <%= @ssl_cipher_suite %>
        SSLCertificateFile <%= @ssl_cert %>
        SSLCertificateKeyFile <%= @ssl_cert_key %>
        SSLCACertificateFile <%= @ssl_ca_cert %>
        <% if ! @ssl_ca_cert_chain.nil? and @ssl_ca_cert_chain != '' %>
        SSLCertificateChainFile <%= @ssl_ca_cert_chain %>
        <% end -%>
        <% end -%>

        DocumentRoot <%= @docroot %>
        <Directory <%= @docroot %>>
                Options None
                AllowOverride None
                Order allow,deny
                allow from all
        </Directory>

        LogLevel warn
        ErrorLog <%= scope.lookupvar('apache::params::log_dir') %>/<%= @server_name %>_error.log
        CustomLog <%= scope.lookupvar('apache::params::log_dir') %>/<%= @server_name %>_access.log combined
</VirtualHost>
